<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Chess</title>
  <meta name="description" content="The HTML5 Herald">
  <meta name="author" content="SitePoint">
  <link rel="stylesheet" href="styles.css">

</head>

<script>

  var currentIndex = 0;
  var currentSelection = "";
  var playersTurn = true;
  var playerPieces = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15];
  var opponentPieces = [48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63];
  var attacker;
  var defender;

  function createButtons() {
    var s = '';
    var red = true;
    var index = 0;

    for (i = 0; i < 8; i++) {
      for (j = 0; j < 8; j++) {

        s += '<button value="' + index++ + '" onclick="buttonOnClick(this.value)" id="close-image" style="background-color: ';

        if (red)
          s += '#D4C4C4; ';       
        else // gray
          s += '#D87D7D; ';
        
        red = !red;

        s += 'left: ' + (560 + j * 100).toString() + 'px; ';
        s += 'top: ' + (100 + i * 100).toString() + 'px; border-color: white"></button>';
      }
      red = !red; // alternate color on next row
    }

    // add New Game button
    s += '<button class="button_new" onclick="newOnClick()" style="background-color: gray;' +
    'position: absolute; left: 860px; top: 20px; width: 200px; height: 50px; font-size: 20pt; font-weight: bold;">New Game</button>';

    document.body.innerHTML = s;
    setDefaultImages();
  }

  function moveOppponent() {

  }

  function setButtonBorder(i, width, color) {
    var btn = document.getElementsByTagName('button')[i];
    if (btn == null)
      return;
    btn.style.borderWidth = width + 'px';
    btn.style.borderColor = color;
  }

  function buttonOnClick(index) {
    attacker = playersTurn ? playerPieces : opponentPieces;
    defender = playersTurn ? opponentPieces : playerPieces;
    var buttons = document.getElementsByTagName('button');

    if (buttons[index].style.borderColor === 'gray') {
      // move selected piece
      var image = buttons[currentIndex].getElementsByTagName('img')[0];
      image.parentElement.removeChild(image);
      buttons[index].appendChild(image);
      attacker[attacker.indexOf(+currentIndex)] = +index;

      if (defender.includes(+index)) {
        // remove piece
        var image = buttons[index].getElementsByTagName('img')[0];
        image.parentElement.removeChild(image);
        defender.splice(defender.indexOf(+index), 1);
      }

      setButtonBorder(index, 2, 'white');
      setButtonBorder(currentIndex, 2, 'white');
      clearMoves();
      playersTurn = !playersTurn;
      return;
    }
    else {
      // don't allow selection on imageless buttons
      var i = buttons[index].getElementsByTagName('img')[0];
      if (i == null)
        return;
    }

    clearMoves();
    
    // don't allow selecting the other players pieces
    if (defender.includes(+index))
      return;    

    setButtonBorder(currentIndex, 2, 'white');
    currentIndex = index; // switch to new index
    setButtonBorder(currentIndex, 5, 'red');

    var i = buttons[currentIndex].getElementsByTagName('img')[0];
    if (i != null) 
      getMove(i.src.toString());
    else 
      currentSelection = "";
  }

  function getMove(s) {

    var buttons = document.getElementsByTagName('button');

    if (s.includes('pawn')) {
        // one space forward (two spaces on first move)
        setPawnMoves();
        currentSelection = "pawn";
      }
      else if (s.includes('rook')) {
        // any number horiz or vert (also moved while castling)
        setVerticalMoves();
        setHorizontalMoves();
        currentSelection = "rook";
      }
      else if (s.includes('knight')) {
        // 2 vert, 1 horz (or vice versa), can jump over pieces
        setKnightMoves();
        currentSelection = "knight";
      }
      else if (s.includes('bishop')) {
        // any number diagonal
        setDiagonalMoves();
        currentSelection = "bishop";
      }
      else if (s.includes('queen')) {
        // any number diagonal, vert, or horiz
        setVerticalMoves();
        setHorizontalMoves();
        setDiagonalMoves();
        currentSelection = "queen";
      }
      else if (s.includes('king')) {
        // one vert, horz, or diagonal (one castling per game)
        setKingMoves();
        currentSelection = "king";
      }
  }

  function setVerticalMoves() {
    var v = 0;
    while (true) {
      v += playersTurn ? 8 : -8;
      if (!attacker.includes(+currentIndex + v) && v <= 64 && v >= -64)
        setButtonBorder(+currentIndex + v, 5, 'gray');
      else
        break;

      if (defender.includes(+currentIndex + v))
        break;
    }

    v = 0;
    while (true) {
      v -= playersTurn ? 8 : -8;
      if (!attacker.includes(+currentIndex + v) && v >= -64 && v <= 64)
        setButtonBorder(+currentIndex + v, 5, 'gray');
      else
        break;

      if (defender.includes(+currentIndex + v))
        break;
    }
  }

  function setHorizontalMoves() {
    var btns = document.getElementsByTagName('button');

    for (i = 0; i < btns.length; i++) {
      if (btns[i].style.top == btns[currentIndex].style.top && i != currentIndex) {       
        if (!attacker.includes(i))
          setButtonBorder(i, 5, 'gray');

        if (defender.includes(i))
          break;
      }
    }

     for (i = 0; i < btns.length; i++) {
      if (btns[i].style.top == btns[currentIndex].style.top && i != currentIndex) {       
        //if (btns[i].style.borderColor === 'gray')
            //setButtonBorder(i, 2, 'white');
      }
    }
  }

  function setDiagonalMove(z) {
    var btns = document.getElementsByTagName('button'); 
    for (i = 1; i < 9; i++) {
      var v = +currentIndex + z * i;
      var btn = btns[v];
      if (btn == null)
        continue;

      if (attacker.includes(v))
        break;

      var z1 = +btn.style.top.replace('px', '');
      var z2 = +btns[currentIndex].style.top.replace('px', '');
      var z3 = +btn.style.left.replace('px', '');
      var z4 = +btns[currentIndex].style.left.replace('px', '');
      // make sure button doesn't go off edge of screen
      if ((z < 0 && z1 < z2 || z > 0 && z1 > z2) &&
         ((z == 9 || z == -7) && z3 > z4) || ((z == 7 || z == -9) && z3 < z4))
        setButtonBorder(v, 5, 'gray');

      if (defender.includes(v))
        break;
    } 
  }

  function setDiagonalMoves() {
    setDiagonalMove(9);
    setDiagonalMove(-9);
    setDiagonalMove(7);
    setDiagonalMove(-7);
  }

  function setPawnMoves() {
    var startingIndexes =  [8, 9, 10, 11, 12, 13, 14, 15, 48, 49, 50, 51, 52, 53, 54, 55];
    var firstmove = +(playersTurn ? 8 : -8);
    var secondMove = +(playersTurn ? 16 : -16);

    // one space forward
    if (!attacker.includes(+currentIndex + firstmove)) {
      setButtonBorder(+currentIndex + firstmove, 5, 'gray');
      if (!attacker.includes(+currentIndex + secondMove) && startingIndexes.includes(+currentIndex) && !defender.includes(+currentIndex + firstmove)) {
        // allow two spaces forward on first move
        setButtonBorder(+currentIndex + secondMove, 5, 'gray');
      }
    }
  }

  function setKnightMoves() {

    var pieces = playersTurn ? playerPieces : opponentPieces;

    if (!attacker.includes(+currentIndex + 17))
      setButtonBorder(+currentIndex + 17, 5, 'gray');

    if (!attacker.includes(+currentIndex - 17))
      setButtonBorder(+currentIndex - 17, 5, 'gray');

    if (!attacker.includes(+currentIndex + 15))   
      setButtonBorder(+currentIndex + 15, 5, 'gray');

    if (!attacker.includes(+currentIndex - 15))
      setButtonBorder(+currentIndex - 15, 5, 'gray');

    if (!attacker.includes(+currentIndex + 10))   
      setButtonBorder(+currentIndex + 10, 5, 'gray');

    if (!attacker.includes(+currentIndex - 10))
      setButtonBorder(+currentIndex - 10, 5, 'gray');

    if (!attacker.includes(+currentIndex + 6))
      setButtonBorder(+currentIndex + 6, 5, 'gray');

    if (!attacker.includes(+currentIndex - 6))
      setButtonBorder(+currentIndex - 6, 5, 'gray');
  }

  function setKingMoves() {

    if (!attacker.includes(+currentIndex + 8))
        setButtonBorder(+currentIndex + 8, 5, 'gray');

    if (!attacker.includes(+currentIndex - 8))
      setButtonBorder(+currentIndex - 8, 5, 'gray');

    var btns = document.getElementsByTagName('button'); 

    if (!attacker.includes(+currentIndex + 1)) {
      var z1 = +btns[+currentIndex + 1].style.left.replace('px', '');
      var z2 = +btns[+currentIndex].style.left.replace('px', '');
      if (z1 > z2) // check if on edge of board
        setButtonBorder(+currentIndex + 1, 5, 'gray');
    } 

    if (!attacker.includes(+currentIndex - 1)) {
      var z1 = +btns[+currentIndex - 1].style.left.replace('px', '');
      var z2 = +btns[+currentIndex].style.left.replace('px', '');
      if (z1 < z2) // check if on edge of board
        setButtonBorder(+currentIndex - 1, 5, 'gray');
    } 
  }

  function clearMoves() {
    for (i = 0; i < 64; i++) {
      var btn = document.getElementsByTagName('button')[i];
      if (btn.style.borderColor == 'gray')
        btn.style.borderWidth = '2px';
        btn.style.borderColor = 'white';
      }
  }

  function setDefaultImages() {

      var buttons = document.getElementsByTagName('button');

      buttons[0].appendChild(getImage('black_rook'));
      buttons[1].appendChild(getImage('black_knight'));
      buttons[2].appendChild(getImage('black_bishop'));
      buttons[3].appendChild(getImage('black_king'));
      buttons[4].appendChild(getImage('black_queen'));
      buttons[5].appendChild(getImage('black_bishop'));
      buttons[6].appendChild(getImage('black_knight'));
      buttons[7].appendChild(getImage('black_rook'));

      for (i = 8; i < 16; i++) {
        buttons[i].appendChild(getImage('black_pawn'));
      }

      for (i = 48; i < 56; i++) {
        buttons[i].appendChild(getImage('white_pawn'));
      }

      buttons[56].appendChild(getImage('white_rook'));
      buttons[57].appendChild(getImage('white_knight'));
      buttons[58].appendChild(getImage('white_bishop'));
      buttons[59].appendChild(getImage('white_king'));
      buttons[60].appendChild(getImage('white_queen'));
      buttons[61].appendChild(getImage('white_bishop'));
      buttons[62].appendChild(getImage('white_knight'));
      buttons[63].appendChild(getImage('white_rook'));
  }

  function getImage(piece) {
      var image = document.createElement('image');
      image.innerHTML = '<img src="' + piece + '.png">';
      return image;
  }

  function newOnClick() {
    createButtons();
    playerPieces = [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15];
    opponentPieces = [48, 49, 50, 51, 52, 53, 54, 55, 56, 57, 58, 59, 60, 61, 62, 63];
  }
</script>

<body onload="createButtons()"></body>
</html>